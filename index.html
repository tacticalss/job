<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø§Ù…Ø¹ Ù…Ø´Ø§ØºÙ„ (Ù…ÙˆÙ„ØªÛŒ Ø³ÙˆØ±Ø³)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f6f7fb; direction: rtl; }
        .search-wrap { max-width: 800px; margin: 60px auto; padding: 0 20px; position: relative; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .search-box-row { display: flex; gap: 10px; position: relative; }
        
        .search-container { flex-grow: 1; position: relative; }
        .search-input { width: 100%; padding: 14px 16px; font-size: 16px; border: 1px solid #d0d5df; border-radius: 12px; box-sizing: border-box; outline: none; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .search-input:focus { border-color: #5d3df5; box-shadow: 0 4px 12px rgba(93, 61, 245, 0.15); }

        .city-select { width: 200px; padding: 14px 16px; font-size: 15px; border: 1px solid #d0d5df; border-radius: 12px; outline: none; background: #fff; cursor: pointer; }
        .city-select:focus { border-color: #5d3df5; }

        /* Suggestions */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; margin-top: 8px; background: #fff; border: 1px solid #e0e4ea; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; z-index: 1000; }
        .suggestion { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f5f7fa; font-size: 14px; color: #444; }
        .suggestion:hover { background: #f8f9fc; color: #5d3df5; }

        /* Results */
        .results-container { margin-top: 30px; display: grid; gap: 15px; }
        .result-card { background: #fff; border: 1px solid #e0e4ea; border-radius: 12px; padding: 16px; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); border-color: #d0d5df; }
        
        /* Source Indicator */
        .source-tag { position: absolute; top: 12px; left: 12px; font-size: 11px; padding: 2px 8px; border-radius: 4px; color: #fff; font-weight: bold; }
        .source-jv { background: #5d3df5; } /* JobVision Color */
        .source-ee { background: #e74c3c; } /* E-Estekhdam Color */
        .source-it { background: #0077b5; } /* IranTalent Color (Blue-ish) */

        .header-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .company-logo { width: 40px; height: 40px; border-radius: 8px; object-fit: contain; background: #fff; border: 1px solid #eee; }
        .job-title { font-weight: bold; font-size: 16px; color: #111; margin: 0; }
        .company-name { font-size: 13px; color: #666; margin-top: 2px; }
        
        .meta-info { display: flex; flex-wrap: wrap; gap: 8px; font-size: 12px; color: #888; margin-top: 8px; }
        .badge { background: #f0f2f5; padding: 4px 8px; border-radius: 6px; color: #555; }
        .salary { color: #2ecc71; font-weight: bold; background: #eafaf1; }

        /* Actions */
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn { border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: bold; display: inline-flex; align-items: center; gap: 6px; color: white; text-decoration: none; }
        .btn:hover { opacity: 0.9; }
        .ai-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .contact-btn { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .apply-btn { background: #333; color: white; margin-right: auto; }

        /* Pagination */
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 30px; padding-bottom: 40px; }
        .page-btn { background: #fff; border: 1px solid #d0d5df; padding: 8px 16px; border-radius: 8px; cursor: pointer; color: #333; }
        .page-btn:disabled { opacity: 0.5; cursor: default; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 16px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow-y: auto; position: relative; animation: slideUp 0.3s ease; }
        .modal-close { position: absolute; top: 16px; left: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .modal-header { font-weight: bold; font-size: 18px; margin-bottom: 16px; color: #333; padding-right: 10px; border-right: 4px solid #5d3df5; }
        .ai-response { line-height: 1.6; color: #444; font-size: 14px; white-space: pre-wrap; }
        .contact-item { background: #f8f9fa; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .contact-row { display: flex; gap: 8px; margin-bottom: 4px; font-size: 14px; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        [hidden] { display: none !important; }
    </style>
</head>
<body>
    <div class="search-wrap">
        <h2>Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø§Ù…Ø¹ Ù…Ø´Ø§ØºÙ„</h2>
        
        <div class="search-box-row">
            <select id="citySelect" class="city-select">
                <option value="">Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§</option>
                <option disabled>Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª...</option>
            </select>
            
            <div class="search-container">
                <input id="search" class="search-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø´ØºÙ„ÛŒ (Ù…Ø«Ù„Ø§: Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³)..." aria-label="search" autocomplete="off" />
                <div id="suggestions" class="suggestions" hidden></div>
            </div>
        </div>
        
        <div id="loading" style="text-align:center; padding:20px; color:#666;" hidden>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹ Ù…Ø®ØªÙ„Ù...</div>
        <div id="results" class="results-container"></div>
        <div id="pagination" class="pagination" hidden></div>
    </div>

    <!-- Modal -->
    <div id="aiModal" class="modal-overlay" hidden>
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalTitle" class="modal-header"></div>
            <div id="aiContent" class="ai-response"></div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const WORKER_URL = 'https://jobvision.messagersr.workers.dev'; 

        function debounce(fn, t){ let id; return (...args)=>{ clearTimeout(id); id = setTimeout(()=>fn(...args), t); }; }

        const input = document.getElementById('search');
        const citySelect = document.getElementById('citySelect');
        const suggestionsEl = document.getElementById('suggestions');
        const resultsEl = document.getElementById('results');
        const loadingEl = document.getElementById('loading');
        const paginationEl = document.getElementById('pagination');
        const aiModal = document.getElementById('aiModal');
        const aiContent = document.getElementById('aiContent');
        const modalTitle = document.getElementById('modalTitle');

        let currentQuery = '';
        let currentPage = 1;

        // --- 0. Load Cities on Startup ---
        async function loadCities() {
            try {
                const res = await fetch(`${WORKER_URL}/cities`);
                const json = await res.json();
                
                // Parse hierarchical data (Province -> Children)
                if (json.data && Array.isArray(json.data)) {
                    citySelect.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§</option>';
                    
                    json.data.forEach(province => {
                        const group = document.createElement('optgroup');
                        group.label = province.title;
                        
                        // Add province itself if needed, or usually just children
                        // JobVision sometimes has "All cities of X" as a child
                        
                        if (province.children) {
                            province.children.forEach(city => {
                                const option = document.createElement('option');
                                // CHANGE: Use urlParameter instead of ID for JobVision/IranTalent
                                option.value = city.urlParameter; 
                                option.textContent = city.title;
                                // Store Persian title for E-Estekhdam filter
                                option.setAttribute('data-title', city.title);
                                group.appendChild(option);
                            });
                        }
                        
                        citySelect.appendChild(group);
                    });
                }
            } catch (e) {
                console.error("Failed to load cities", e);
                citySelect.innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ù‡Ø±Ù‡Ø§</option>';
            }
        }
        
        loadCities();

        // --- 1. Suggestions (Proxied via Worker) ---
        async function fetchSuggestions(q){
            q = (q||'').trim();
            if(!q){ suggestionsEl.hidden = true; return; }
            const url = `${WORKER_URL}/api/v1/Basedata/GetListOfSuggestedKeywords?keyword=${encodeURIComponent(q)}`;
            try{
                const resp = await fetch(url);
                const json = await resp.json();
                renderSuggestions(json.data || []);
            } catch(err){
                suggestionsEl.hidden = true;
            }
        }

        function renderSuggestions(items){
            suggestionsEl.innerHTML = '';
            if(!items || items.length === 0){ suggestionsEl.hidden = true; return; }
            items.forEach(it => {
                const div = document.createElement('div');
                div.className = 'suggestion';
                div.textContent = it.name || it.title;
                div.onclick = () => {
                    input.value = div.textContent;
                    suggestionsEl.hidden = true;
                    fetchSearch(div.textContent, 1);
                };
                suggestionsEl.appendChild(div);
            });
            suggestionsEl.hidden = false;
        }

        const onInput = debounce((e)=>{ fetchSuggestions(e.target.value); }, 300);
        input.addEventListener('input', onInput);

        // --- 2. Search (Aggregated via Worker) ---
        async function fetchSearch(q, page = 1){
            q = (q||'').trim();
            if(!q) return;

            currentQuery = q;
            currentPage = page;
            suggestionsEl.hidden = true;
            loadingEl.hidden = false;
            resultsEl.innerHTML = '';
            paginationEl.hidden = true;
            
            const selectedCityParam = citySelect.value;
            // Get Persian Title from selected option
            let selectedCityName = null;
            if (citySelect.selectedIndex >= 0) {
                const selectedOption = citySelect.options[citySelect.selectedIndex];
                // Only get data-title if it's not the default "All Cities" option
                if (selectedOption.value) {
                    selectedCityName = selectedOption.getAttribute('data-title');
                }
            }

            try {
                // Sending payload including CITY (URL Parameter) and Persian Title
                const resp = await fetch(`${WORKER_URL}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        keyword: q, 
                        page: page,
                        city: selectedCityParam, // Send City Slug (for JobVision & IranTalent)
                        cityTitle: selectedCityName // Send Persian Title (for E-Estekhdam)
                    })
                });

                const json = await resp.json();
                loadingEl.hidden = true;

                if(json.data && json.data.length > 0){
                    renderResults(json.data);
                    renderPagination(json.data.length, page);
                } else {
                    resultsEl.innerHTML = '<div style="text-align:center; color:#888;">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
                }

            } catch(err) {
                loadingEl.hidden = true;
                resultsEl.innerHTML = '<div style="text-align:center; color:red;">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</div>';
                console.error(err);
            }
        }

        function renderResults(items){
            items.forEach(item => {
                const isEE = item.source === 'e-estekhdam';
                const isIT = item.source === 'irantalent';
                
                let sourceName = 'Ø¬Ø§Ø¨â€ŒÙˆÛŒÚ˜Ù†';
                let sourceClass = 'source-jv';
                
                if (isEE) {
                    sourceName = 'Ø§ÛŒ-Ø§Ø³ØªØ®Ø¯Ø§Ù…';
                    sourceClass = 'source-ee';
                } else if (isIT) {
                    sourceName = 'Ø§ÛŒØ±Ø§Ù†â€ŒØªÙ„Ù†Øª';
                    sourceClass = 'source-it';
                }
                
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <div class="source-tag ${sourceClass}">${sourceName}</div>
                    <div class="header-row">
                        ${item.logo ? `<img src="${item.logo}" class="company-logo" onerror="this.style.display='none'">` : '<div class="company-logo" style="display:flex;align-items:center;justify-content:center;">ğŸ¢</div>'}
                        <div>
                            <div class="job-title">${item.title}</div>
                            <div class="company-name">${item.company}</div>
                        </div>
                    </div>
                    <div class="meta-info">
                        ${item.location ? `<span class="badge">ğŸ“ ${item.location}</span>` : ''}
                        ${item.contract ? `<span class="badge">ğŸ“„ ${item.contract}</span>` : ''}
                        ${item.salary ? `<span class="badge salary">ğŸ’° ${item.salary}</span>` : ''}
                    </div>
                    <div class="actions">
                        <button class="btn ai-btn" onclick="analyzeJob('${item.title}', '${item.company}')">âœ¨ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</button>
                        <button class="btn contact-btn" onclick="fetchContact('${item.company}')">ğŸ“ ØªÙ…Ø§Ø³</button>
                        <a href="${item.link}" target="_blank" class="btn apply-btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ú¯Ù‡ÛŒ â†—</a>
                    </div>
                `;
                resultsEl.appendChild(card);
            });
        }

        function renderPagination(currentCount, page){
            paginationEl.innerHTML = '';
            
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.innerText = 'ØµÙØ­Ù‡ Ù‚Ø¨Ù„';
            prevBtn.disabled = page <= 1;
            prevBtn.onclick = () => fetchSearch(currentQuery, page - 1);

            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.innerText = 'ØµÙØ­Ù‡ Ø¨Ø¹Ø¯';
            nextBtn.disabled = currentCount < 5; 
            nextBtn.onclick = () => fetchSearch(currentQuery, page + 1);

            paginationEl.appendChild(prevBtn);
            paginationEl.appendChild(nextBtn);
            paginationEl.hidden = false;
        }

        // --- AI Features ---
        async function analyzeJob(title, company) {
            aiModal.hidden = false;
            modalTitle.innerText = 'âœ¨ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯';
            modalTitle.style.borderRightColor = '#764ba2';
            aiContent.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...';
            
            const prompt = `Ø¨Ø¹Ù†ÙˆØ§Ù† Ù…Ø´Ø§ÙˆØ± Ø´ØºÙ„ÛŒØŒ Ø¨Ø±Ø§ÛŒ Ø¢Ú¯Ù‡ÛŒ "${title}" Ø¯Ø± Ø´Ø±Ú©Øª "${company}" Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø±Ø§ Ú©ÙˆØªØ§Ù‡ Ø¨Ù†ÙˆÛŒØ³: 1. Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ 2. Ø³ÙˆØ§Ù„Ø§Øª Ù…ØµØ§Ø­Ø¨Ù‡ 3. Ù…ØªÙ† Ú©Ø§ÙˆØ± Ù„ØªØ±.`;
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù¾Ø§Ø³Ø®';
                aiContent.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            } catch(e) { aiContent.innerText = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·'; }
        }

        async function fetchContact(company) {
            aiModal.hidden = false;
            modalTitle.innerText = 'ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³';
            modalTitle.style.borderRightColor = '#38ef7d';
            aiContent.innerHTML = 'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...';
            try {
                // Using external worker for contact info as before
                const res = await fetch('https://perp.messagersr.workers.dev/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ company })
                });
                const json = await res.json();
                const data = (json.data || json); 
                if(Array.isArray(data) && data.length){
                    aiContent.innerHTML = data.map(d => `
                        <div class="contact-item">
                            <b>${d.company || company}</b><br>
                            ${d.phone_number ? `ğŸ“± ${d.phone_number}<br>` : ''}
                            ${d.email ? `ğŸ“§ ${d.email}<br>` : ''}
                            ${d.website ? `ğŸŒ <a href="${d.website}" target="_blank">ÙˆØ¨Ø³Ø§ÛŒØª</a>` : ''}
                        </div>
                    `).join('');
                } else { aiContent.innerText = 'Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.'; }
            } catch(e) { aiContent.innerText = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª'; }
        }

        function closeModal() { aiModal.hidden = true; }
        aiModal.onclick = (e) => { if(e.target===aiModal) closeModal(); };
        input.onkeydown = (e) => { if(e.key==='Enter') { e.preventDefault(); fetchSearch(input.value, 1); } };
    </script>
</body>
</html>
