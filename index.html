<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø¬Ø³ØªØ¬ÙˆÛŒ Ø²Ù†Ø¯Ù‡ Ù…Ø´Ø§ØºÙ„ + Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f6f7fb; direction: rtl; }
        .search-wrap { max-width: 600px; margin: 60px auto; padding: 0 20px; position: relative; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .search-container { position: relative; }
        .search-input { width: 100%; padding: 14px 16px; font-size: 16px; border: 1px solid #d0d5df; border-radius: 12px; box-sizing: border-box; outline: none; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .search-input:focus { border-color: #5d3df5; box-shadow: 0 4px 12px rgba(93, 61, 245, 0.15); }

        /* Suggestions Dropdown */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; margin-top: 8px; background: #fff; border: 1px solid #e0e4ea; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; z-index: 1000; }
        .suggestion { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f5f7fa; font-size: 14px; color: #444; transition: background 0.1s; }
        .suggestion:last-child { border-bottom: 0; }
        .suggestion:hover { background: #f8f9fc; color: #5d3df5; }

        /* Results List */
        .results-container { margin-top: 30px; }
        .result-card { background: #fff; border: 1px solid #e0e4ea; border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; gap: 8px; position: relative; }
        .result-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); border-color: #d0d5df; }
        
        .job-title { font-weight: bold; font-size: 16px; color: #111; }
        .company-name { font-size: 13px; color: #666; display: flex; align-items: center; gap: 6px; }
        .company-logo { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background: #eee; }
        .meta-info { display: flex; flex-wrap: wrap; gap: 10px; font-size: 12px; color: #888; margin-top: 4px; }
        .badge { background: #f0f2f5; padding: 4px 8px; border-radius: 6px; color: #555; }
        .salary { color: #2ecc71; font-weight: bold; background: #eafaf1; }

        /* Actions Bar */
        .actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }

        /* Buttons */
        .btn {
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
            color: white;
        }
        .btn:hover { opacity: 0.9; }

        .ai-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .contact-btn { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }

        /* Pagination */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding-bottom: 40px; }
        .page-btn { background: #fff; border: 1px solid #d0d5df; padding: 8px 16px; border-radius: 8px; cursor: pointer; color: #333; transition: all 0.2s; font-family: inherit; }
        .page-btn:hover:not(:disabled) { border-color: #5d3df5; color: #5d3df5; background: #f8f9fc; }
        .page-btn:disabled { opacity: 0.5; cursor: default; background: #f0f0f0; }
        .page-info { font-size: 14px; color: #666; font-weight: bold; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-width: 500px; max-height: 80vh; border-radius: 16px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow-y: auto; position: relative; animation: slideUp 0.3s ease; }
        .modal-close { position: absolute; top: 16px; left: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .modal-header { font-weight: bold; font-size: 18px; margin-bottom: 16px; color: #333; padding-right: 10px; border-right: 4px solid #5d3df5; }
        .ai-response { line-height: 1.6; color: #444; font-size: 14px; white-space: pre-wrap; }
        
        /* Contact List Styles */
        .contact-item { background: #f8f9fa; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .contact-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 14px; }
        .contact-label { color: #666; font-size: 12px; min-width: 60px; }
        .contact-value { color: #333; font-weight: 500; word-break: break-all; }
        .contact-link { color: #5d3df5; text-decoration: none; }
        .contact-link:hover { text-decoration: underline; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .muted { color: #888; font-size: 14px; padding: 20px; text-align: center; }
        .loading { text-align: center; padding: 20px; color: #5d3df5; }
        
        [hidden] { display: none !important; }
    </style>
</head>
<body>
    <div class="search-wrap">
        <h2>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´Ø§ØºÙ„</h2>
        <div class="search-container">
            <input id="search" class="search-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø´ØºÙ„ÛŒØŒ Ù…Ù‡Ø§Ø±Øª ÛŒØ§ Ù†Ø§Ù… Ø´Ø±Ú©Øª..." aria-label="search" autocomplete="off" />
            <div id="suggestions" class="suggestions" hidden></div>
        </div>
        
        <div id="loading" class="loading" hidden>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</div>
        <div id="results" class="results-container"></div>
    </div>

    <!-- Modal for AI/Contact Response -->
    <div id="aiModal" class="modal-overlay" hidden>
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalTitle" class="modal-header"></div>
            <div id="aiContent" class="ai-response"></div>
        </div>
    </div>

    <script>
        const apiKey = ""; // System will provide the key
        
        function debounce(fn, t){ let id; return (...args)=>{ clearTimeout(id); id = setTimeout(()=>fn(...args), t); }; }

        const input = document.getElementById('search');
        const suggestionsEl = document.getElementById('suggestions');
        const resultsEl = document.getElementById('results');
        const loadingEl = document.getElementById('loading');
        const aiModal = document.getElementById('aiModal');
        const aiContent = document.getElementById('aiContent');
        const modalTitle = document.getElementById('modalTitle');

        let currentQuery = '';
        let currentPage = 1;

        // --- 1. Handle Suggestions (GET Request) ---
        function renderSuggestions(items){
            suggestionsEl.innerHTML = '';
            if(!items || items.length === 0){
                suggestionsEl.hidden = true;
                return;
            }
            items.forEach(it => {
                const div = document.createElement('div');
                div.className = 'suggestion';
                const text = (typeof it === 'string') ? it : (it.name || it.title || '');
                div.textContent = text;
                div.addEventListener('click', () => {
                    input.value = text;
                    suggestionsEl.hidden = true;
                    // Reset to page 1 on new suggestion click
                    fetchSearch(text, 1);
                });
                suggestionsEl.appendChild(div);
            });
            suggestionsEl.hidden = false;
        }

        async function fetchSuggestions(q){
            q = (q||'').trim();
            if(!q){ suggestionsEl.hidden = true; return; }
            
            const url = 'https://jobvision.messagersr.workers.dev/api/v1/Basedata/GetListOfSuggestedKeywords?keyword=' + encodeURIComponent(q);
            
            try{
                const resp = await fetch(url, { method:'GET', headers:{ 'Accept':'application/json' }});
                const json = await resp.json();
                
                if(json && json.data && Array.isArray(json.data)){
                    renderSuggestions(json.data);
                } else {
                    suggestionsEl.hidden = true;
                }
            } catch(err){
                console.warn('Suggestion error:', err);
                suggestionsEl.hidden = true;
            }
        }

        const onInput = debounce((e)=>{ fetchSuggestions(e.target.value); }, 300);
        input.addEventListener('input', onInput);


        // --- 2. Handle Search Results (POST Request) ---
        function renderResults(jobPosts, q){
            resultsEl.innerHTML = '';
            
            if(!jobPosts || jobPosts.length === 0){
                resultsEl.innerHTML = '<div class="muted">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ "'+(q||'')+'" ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
                return;
            }

            const countInfo = document.createElement('div');
            countInfo.className = 'muted';
            countInfo.style.padding = '0 0 10px 0';
            countInfo.style.textAlign = 'right';
            countInfo.textContent = `Ù†ØªØ§ÛŒØ¬ Ø¨Ø±Ø§ÛŒ "${q}" - ØµÙØ­Ù‡ ${currentPage}`;
            resultsEl.appendChild(countInfo);

            jobPosts.forEach(job => {
                const title = job.title;
                const companyName = job.company ? job.company.nameFa : 'Ù†Ø§Ù…Ø´Ø®Øµ';
                const logoUrl = job.company ? job.company.logoUrl : '';
                const city = (job.location && job.location.city) ? job.location.city.titleFa : '';
                const salary = (job.salary && job.salary.titleFa) ? job.salary.titleFa : '';
                const contractType = (job.workType && job.workType.titleFa) ? job.workType.titleFa : '';

                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <div class="job-title">${title}</div>
                    <div class="company-name">
                        ${logoUrl ? `<img src="${logoUrl}" class="company-logo" onerror="this.style.display='none'">` : ''}
                        <span>${companyName}</span>
                    </div>
                    <div class="meta-info">
                        ${city ? `<span class="badge">${city}</span>` : ''}
                        ${contractType ? `<span class="badge">${contractType}</span>` : ''}
                        ${salary ? `<span class="badge salary">${salary}</span>` : ''}
                    </div>
                    <div class="actions">
                        <button class="btn ai-btn" onclick="analyzeJob('${title}', '${companyName}')">
                            âœ¨ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯
                        </button>
                        <button class="btn contact-btn" onclick="fetchContact('${companyName}')">
                            ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³
                        </button>
                    </div>
                `;
                resultsEl.appendChild(card);
            });
        }

        // Render Pagination Controls
        function renderPagination(totalCount, page) {
            const pageSize = 30; // Based on log
            const totalPages = Math.ceil(totalCount / pageSize);
            
            if (totalPages <= 1) return;

            const div = document.createElement('div');
            div.className = 'pagination';

            // Previous Button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'page-btn';
            prevBtn.textContent = 'Ù‚Ø¨Ù„ÛŒ';
            prevBtn.disabled = page === 1;
            prevBtn.onclick = () => {
                fetchSearch(currentQuery, page - 1);
                // Scroll to top of results
                resultsEl.scrollIntoView({behavior: 'smooth'});
            };

            // Info text
            const info = document.createElement('span');
            info.className = 'page-info';
            info.textContent = `ØµÙØ­Ù‡ ${page} Ø§Ø² ${totalPages}`;

            // Next Button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'page-btn';
            nextBtn.textContent = 'Ø¨Ø¹Ø¯ÛŒ';
            nextBtn.disabled = page >= totalPages;
            nextBtn.onclick = () => {
                fetchSearch(currentQuery, page + 1);
                resultsEl.scrollIntoView({behavior: 'smooth'});
            };

            div.appendChild(prevBtn);
            div.appendChild(info);
            div.appendChild(nextBtn);

            resultsEl.appendChild(div);
        }

        async function fetchSearch(q, page = 1){
            q = (q||'').trim();
            if(!q) return;

            // Update Global State
            currentQuery = q;
            currentPage = page;

            suggestionsEl.hidden = true; 
            loadingEl.hidden = false;
            resultsEl.innerHTML = ''; 

            const url = 'https://jobvision.messagersr.workers.dev/api/v1/JobPost/List';
            
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json, text/plain, */*',
                'clientId': '49935615',
                'Web-App-Version': '19.0.81',
                'ngsw-bypass': 'true',
                'Authorization': 'Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IkZEMjczNDJEQjU4RTFFREZEMzJBODQ4MUVGODU0REUwQzI5Q0I3MzdSUzI1NiIsIng1dCI6Il9TYzBMYldPSHRfVEtvU0I3NFZONE1LY3R6YyIsInR5cCI6ImF0K2p3dCJ9.eyJpc3MiOiJodHRwczovL2FjY291bnQuam9idmlzaW9uLmlyIiwibmJmIjoxNzY1NDUwMzAxLCJpYXQiOjE3NjU0NTAzMDEsImV4cCI6MTc2NTUzNjcwMSwiYXVkIjpbIkpvYlZpc2lvbkFwaSIsIklkZW50aXR5U2VydmVyQXBpIl0sInNjb3BlIjpbIm9wZW5pZCIsInByb2ZpbGUiLCJKb2JWaXNpb25BcGkiLCJyb2xlcyIsIklkZW50aXR5U2VydmVyQXBpIiwib2ZmbGluZV9hY2Nlc3MiXSwiYW1yIjpbInB3ZCJdLCJjbGllbnRfaWQiOiJKb2JWaXNpb25Bbmd1bGFyQ2xpZW50Iiwic3ViIjoiNTMwOTQ4MiIsImF1dGhfdGltZSI6MTc2MzU2NzUzMiwiaWRwIjoibG9jYWwiLCJlbWFpbCI6ImhlbGxva29tZXlsQGdtYWlsLmNvbSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IkVtcGxveWVlIiwiUm9sZSI6IkVtcGxveWVlIiwiRnVsbE5hbWUiOiLaqdmF24zZhCDYqNmE2qnYp9mF2YciLCJTdWJtaXRUaW1lIjoiMjAyNS0xMS0xOVQxOToyMTo0OCIsInNpZCI6IjU3REI0RjgwNDkwODFBOEUzREI4QzcxNzk0NTYwMkNCIiwianRpIjoiOEE4OThDRjlBOENCOURCQ0U0RDI2RDgyRjI2RTdDMDUifQ.uT5jkbbzWc32bWElhuRf2hyiJwg9YJn63UNdt6HR-vLAtYCWATxfv9ivW1y-XpFdwF5MqdefllWWDFVRPtUXq53EQF0onOtAnFykLjPEQf1XmUAU3cQmkQw7LLnX9OjCBfWKWbdT1E1liNXDO-0WUC8dKGHpqQVfqg8wPjIRVdJ8eHsw4KcB-sTeG4shwcwkkLYqL0ZodlrxNhJp1ediKQuuCpuIoI6KVdFIvWai-4qCzpfwCB6AA-8nsajznWhc29ABU0i7yZZDlLIB8FUQ8N3f8Xz3tx7W_s2l-A0qAB7k6lWfogn4DfMLmwSdgQJrdOjXzIyBSDJMP0ycd7PX1Q'
            };

            const payload = {
                pageSize: 30,
                requestedPage: page, // Using dynamic page number
                keyword: q,
                sortBy: 1,
                searchId: null
            };

            try{
                const resp = await fetch(url, { 
                    method: 'POST', 
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    throw new Error(`Server returned ${resp.status}`);
                }

                const json = await resp.json();
                loadingEl.hidden = true;

                if(json && json.data && Array.isArray(json.data.jobPosts)){
                    renderResults(json.data.jobPosts, q);
                    // Add Pagination Controls
                    if (json.data.jobPostCount) {
                        renderPagination(json.data.jobPostCount, page);
                    }
                } else {
                    renderResults([], q);
                }

            } catch(err){
                console.error('Search fetch error:', err);
                loadingEl.hidden = true;
                resultsEl.innerHTML = `<div class="muted" style="color:red">
                    Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.<br>
                    <small style="color:#666; display:block; margin-top:5px;">
                        Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…Ø´Ú©Ù„ Ø§Ø² Ù¾Ø±ÙˆÚ©Ø³ÛŒ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ (CORS) Ø¨Ø§Ø´Ø¯.<br>
                        Error: ${err.message}
                    </small>
                </div>`;
            }
        }

        // --- 3. Gemini AI Analysis ---
        async function analyzeJob(title, company) {
            aiModal.hidden = false;
            modalTitle.innerText = 'âœ¨ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø´ØºÙ„';
            modalTitle.style.borderRightColor = '#764ba2'; // Purple
            aiContent.innerHTML = '<div style="text-align:center; padding:20px;">ğŸ”® Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´ØºÙ„ÛŒ...<br><small>Ù„Ø·ÙØ§ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</small></div>';
            
            const prompt = `Ø´Ù…Ø§ ÛŒÚ© Ù…Ø´Ø§ÙˆØ± Ø´ØºÙ„ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù‡Ø³ØªÛŒØ¯.
            Ø¨Ø±Ø§ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´ØºÙ„ÛŒ Ø²ÛŒØ±:
            Ø¹Ù†ÙˆØ§Ù†: ${title}
            Ø´Ø±Ú©Øª: ${company}

            Ù„Ø·ÙØ§ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø±Ø§ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ùˆ Ø¨Ø§ Ù„Ø­Ù†ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯:
            1. Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ú©Ù‡ Ø§Ø­ØªÙ…Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø´ØºÙ„ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø§Ø³Øª.
            2. Ø³Ù‡ Ø³ÙˆØ§Ù„ Ù…Ù‡Ù… Ú©Ù‡ Ø§Ø­ØªÙ…Ø§Ù„ Ø¯Ø§Ø±Ø¯ Ø¯Ø± Ù…ØµØ§Ø­Ø¨Ù‡ Ù¾Ø±Ø³ÛŒØ¯Ù‡ Ø´ÙˆØ¯.
            3. ÛŒÚ© Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù Ú©ÙˆØªØ§Ù‡ Ùˆ Ø¬Ø°Ø§Ø¨ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù†Ø§Ù…Ù‡ Ù¾ÙˆØ´Ø´ÛŒ (Cover Letter) Ø®Ø·Ø§Ø¨ Ø¨Ù‡ Ø§ÛŒÙ† Ø´Ø±Ú©Øª.
            
            Ù¾Ø§Ø³Ø® Ø±Ø§ Ø³Ø§Ø®ØªØ§Ø± ÛŒØ§ÙØªÙ‡ Ùˆ Ù…Ø±ØªØ¨ Ø¨Ø¯Ù‡ÛŒØ¯.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    const text = data.candidates[0].content.parts[0].text;
                    const formattedText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*/g, 'â€¢');
                    aiContent.innerHTML = formattedText;
                } else {
                    aiContent.textContent = "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆØ§Ù†Ø³ØªÙ… Ù¾Ø§Ø³Ø®ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ù…. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
                }
            } catch (error) {
                console.error("Gemini Error:", error);
                aiContent.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ. Ù„Ø·ÙØ§ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
            }
        }

        // --- 4. Custom Contact Extraction API ---
        async function fetchContact(companyName) {
            aiModal.hidden = false;
            modalTitle.innerText = 'ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ø´Ø±Ú©Øª';
            modalTitle.style.borderRightColor = '#38ef7d'; // Green
            aiContent.innerHTML = '<div style="text-align:center; padding:20px;">ğŸ“¡ Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³...<br><small>Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ</small></div>';

            try {
                const response = await fetch('https://perp.messagersr.workers.dev/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ company: companyName })
                });

                const json = await response.json();
                
                // Adjusted to read from json.data based on new response format
                const data = (json && json.data && Array.isArray(json.data)) ? json.data : [];
                
                if (data.length > 0) {
                    let html = '';
                    data.forEach(item => {
                        html += `
                        <div class="contact-item">
                            <div style="font-weight:bold; margin-bottom:8px; border-bottom:1px solid #ddd; padding-bottom:4px;">${item.company || companyName}</div>
                            
                            ${item.phone_number ? `
                            <div class="contact-row">
                                <span class="contact-label">ØªÙ„ÙÙ†:</span>
                                <span class="contact-value"><a href="tel:${item.phone_number}" class="contact-link" dir="ltr">${item.phone_number}</a></span>
                            </div>` : ''}

                            ${item.second_number ? `
                            <div class="contact-row">
                                <span class="contact-label">ØªÙ„ÙÙ† Ø¯ÙˆÙ…:</span>
                                <span class="contact-value"><a href="tel:${item.second_number}" class="contact-link" dir="ltr">${item.second_number}</a></span>
                            </div>` : ''}
                            
                            ${item.email ? `
                            <div class="contact-row">
                                <span class="contact-label">Ø§ÛŒÙ…ÛŒÙ„:</span>
                                <span class="contact-value"><a href="mailto:${item.email}" class="contact-link">${item.email}</a></span>
                            </div>` : ''}
                            
                            ${item.website ? `
                            <div class="contact-row">
                                <span class="contact-label">ÙˆØ¨Ø³Ø§ÛŒØª:</span>
                                <span class="contact-value"><a href="${item.website}" target="_blank" class="contact-link">${item.website}</a></span>
                            </div>` : ''}
                        </div>`;
                    });
                    aiContent.innerHTML = html;
                } else {
                    aiContent.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø´Ø±Ú©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
                }

            } catch (error) {
                console.error("Contact Fetch Error:", error);
                aiContent.innerHTML = `<div style="color:red; text-align:center; padding:20px;">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³.<br><small>${error.message}</small></div>`;
            }
        }

        function closeModal() {
            aiModal.hidden = true;
        }

        // Close modal on click outside
        aiModal.addEventListener('click', (e) => {
            if (e.target === aiModal) closeModal();
        });

        // Hide suggestions on click outside
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.search-wrap')) {
                suggestionsEl.hidden = true;
            }
        });

        // Search on Enter
        input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter'){
                e.preventDefault();
                // Reset to page 1 on new search
                fetchSearch(e.target.value, 1);
            }
        });
    </script>
</body>
</html>
